<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HAProxy Config Viewer</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            height: 100vh;
            overflow-x: hidden;
        }
        #fileList {
            width: 30%;
            overflow-y: auto;
            border-right: 1px solid #ccc;
            padding: 10px;
        }
        #fileList ul {
            list-style-type: none;
            padding: 0;
        }
        #fileList li {
            cursor: pointer;
            padding: 5px;
            margin-bottom: 5px;
            background-color: #f4f4f4;
        }
        #fileList li:hover {
            background-color: #e0e0e0;
        }
        #fileContent {
            width: 70%;
            display: flex;
            flex-direction: column;
        }
        .button-container {
            padding: 10px;
            display: flex;
            justify-content: space-between;
        }
        .left-buttons {
            display: flex;
        }
        button {
            margin-right: 10px;
        }
        #contentWrapper {
            display: flex;
            flex-direction: column;
            height: calc(100% - 50px);
        }
        #contentArea {
            flex: 7;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: monospace;
            padding: 10px;
            overflow-y: auto;
        }
        #resultsArea {
            flex: 3;
            border-top: 1px solid #ccc;
            padding: 10px;
            overflow-y: auto;
            background-color: #f9f9f9;
        }
        #resultsArea ul {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }
        #resultsArea li {
            padding: 5px;
            border-bottom: 1px solid #eee;
            font-family: monospace;
        }
        #resultsArea li:last-child {
            border-bottom: none;
        }
        .config {
            color: #FF9800;  /* Orange */
        }
        .error {
            color: #F44336;  /* Red */
            font-weight: bold;
        }
        .notice {
            color: #4CAF50;  /* Green */
        }
        .warning {
            color: #F44336;  /* Red */
        }
        #settingsPage {
            position: fixed;
            top: 0;
            right: -100%;
            width: 100%;
            height: 100%;
            background-color: white;
            transition: right 0.3s ease-in-out;
            z-index: 1000;
            padding: 20px;
            box-sizing: border-box;
        }
        #settingsPage.open {
            right: 0;
        }
        #backButton {
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div id="fileList">
        <h2>CFG Files</h2>
        <ul></ul>
    </div>
    <div id="fileContent">
        <div class="button-container">
            <div class="left-buttons">
                <button id="editButton">Edit</button>
                <button id="saveButton" style="display: none;">Save</button>
                <button id="testConfigButton">Test Config</button>
            </div>
            <button id="settingsButton">Settings</button>
        </div>
        <div id="contentWrapper">
            <textarea id="contentArea" readonly></textarea>
            <div id="resultsArea"></div>
        </div>
    </div>
    <div id="settingsPage">
        <button id="backButton">Back</button>
        <h2>Settings</h2>
        <label for="haproxyPath">HAProxy Config Path:</label>
        <input type="text" id="haproxyPath" name="haproxyPath"><br><br>
        <label for="confdPath">conf.d Folder Path:</label>
        <input type="text" id="confdPath" name="confdPath"><br><br>
        <button id="saveSettings">Save Settings</button>
    </div>

    <script>
        const fileList = document.querySelector('#fileList ul');
        const contentArea = document.getElementById('contentArea');
        const resultsArea = document.getElementById('resultsArea');
        const editButton = document.getElementById('editButton');
        const saveButton = document.getElementById('saveButton');
        const testConfigButton = document.getElementById('testConfigButton');
        const settingsButton = document.getElementById('settingsButton');
        const settingsPage = document.getElementById('settingsPage');
        const backButton = document.getElementById('backButton');
        const saveSettingsButton = document.getElementById('saveSettings');
        let currentFile = '';

        fetch('/api/cfgfiles')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(files => {
                console.log('Received files:', files);
                if (files.length === 0) {
                    console.log('No .cfg files found');
                    fileList.innerHTML = '<li>No .cfg files found</li>';
                } else {
                    files.forEach(file => {
                        const li = document.createElement('li');
                        li.textContent = file;
                        li.onclick = () => loadFileContent(file);
                        fileList.appendChild(li);
                    });
                }
            })
            .catch(error => {
                console.error('Error fetching cfg files:', error);
                fileList.innerHTML = '<li>Error loading files</li>';
            });

        function loadFileContent(filename) {
            currentFile = filename;
            fetch(`/api/file/${encodeURIComponent(filename)}`)
                .then(response => response.text())
                .then(content => {
                    contentArea.value = content;
                    contentArea.readOnly = true;
                    editButton.style.display = 'inline';
                    saveButton.style.display = 'none';
                })
                .catch(error => console.error('Error:', error));
        }

        editButton.addEventListener('click', () => {
            contentArea.readOnly = false;
            editButton.style.display = 'none';
            saveButton.style.display = 'inline';
        });

        saveButton.addEventListener('click', () => {
            fetch(`/api/save/${encodeURIComponent(currentFile)}`, {
                method: 'POST',
                body: contentArea.value,
                headers: {
                    'Content-Type': 'text/plain'
                }
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => { throw new Error(text) });
                }
                return response.text();
            })
            .then(result => {
                alert(result);
                contentArea.readOnly = true;
                editButton.style.display = 'inline';
                saveButton.style.display = 'none';
            })
            .catch(error => {
                console.error('Error:', error);
                alert(`Error saving file: ${error.message}`);
            });
        });

        testConfigButton.addEventListener('click', () => {
            fetch('/api/testconfig', {
                method: 'POST',
                body: JSON.stringify({ filename: currentFile }),
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.text())
            .then(result => {
                const lines = result.split('\n');
                const formattedResult = lines.map(line => {
                    let className = 'config';  // Default class
                    if (line.includes('ERROR') || line.includes('Error')) {
                        className = 'error';
                    } else if (line.includes('NOTICE')) {
                        className = 'notice';
                    } else if (line.includes('WARNING')) {
                        className = 'warning';
                    } else if (line.includes('ALERT')) {
                        className = 'error';  // Treating ALERT as error
                    }
                    return `<li class="${className}">${line}</li>`;
                }).join('');
                resultsArea.innerHTML = `<ul>${formattedResult}</ul>`;
            })
            .catch(error => {
                console.error('Error:', error);
                resultsArea.innerHTML = `<ul><li class="error">Error testing config: ${error.message}</li></ul>`;
            });
        });

        settingsButton.addEventListener('click', () => {
            settingsPage.classList.add('open');
            fetch('/api/settings')
                .then(response => response.json())
                .then(settings => {
                    document.getElementById('haproxyPath').value = settings.haproxyPath;
                    document.getElementById('confdPath').value = settings.confdPath;
                });
        });

        backButton.addEventListener('click', () => {
            settingsPage.classList.remove('open');
        });

        saveSettingsButton.addEventListener('click', () => {
            const settings = {
                haproxyPath: document.getElementById('haproxyPath').value,
                confdPath: document.getElementById('confdPath').value
            };
            fetch('/api/settings', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(settings),
            })
            .then(response => response.json())
            .then(data => {
                alert('Settings saved successfully');
                settingsPage.classList.remove('open');
            })
            .catch((error) => {
                console.error('Error:', error);
                alert('Error saving settings');
            });
        });
    </script>
</body>
</html>
